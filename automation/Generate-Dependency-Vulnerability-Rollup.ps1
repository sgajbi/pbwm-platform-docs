param(
    [string]$ReposPath = "automation/repos.json",
    [string]$OutputJsonPath = "output/dependency-vulnerability-rollup.json",
    [string]$OutputMarkdownPath = "output/dependency-vulnerability-rollup.md"
)

$ErrorActionPreference = "Stop"
$PSNativeCommandUseErrorActionPreference = $false

if (-not (Test-Path $ReposPath)) {
    throw "Repos config not found: $ReposPath"
}

$reposConfig = Get-Content -Raw $ReposPath | ConvertFrom-Json
$repoEntries = if ($reposConfig -is [System.Array]) { $reposConfig } elseif ($reposConfig.repositories) { $reposConfig.repositories } else { @() }
$targetRepos = @(
    $repoEntries |
        Where-Object { $_.name -like "lotus-*" -and $_.name -ne "lotus-platform" } |
        ForEach-Object { $_ }
)

function Resolve-SecurityCommand {
    param([string]$RepoPath)

    if (Test-Path (Join-Path $RepoPath "scripts/dependency_health_check.py")) {
        if (Test-Path (Join-Path $RepoPath "requirements.txt")) {
            return "python scripts/dependency_health_check.py --requirements requirements.txt"
        }
        return "python scripts/dependency_health_check.py"
    }
    if (Test-Path (Join-Path $RepoPath "requirements-audit.txt")) {
        return "python -m pip_audit -r requirements-audit.txt"
    }
    if (Test-Path (Join-Path $RepoPath "requirements.txt")) {
        return "python -m pip_audit -r requirements.txt"
    }
    if (Test-Path (Join-Path $RepoPath "package.json")) {
        return "npm audit --audit-level=high --json"
    }
    if (Test-Path (Join-Path $RepoPath "pyproject.toml")) {
        return "python -m pip_audit"
    }
    return $null
}

$results = @()

foreach ($repo in $targetRepos) {
    $repoPath = [string]$repo.path
    if (-not [System.IO.Path]::IsPathRooted($repoPath)) {
        $repoPath = Join-Path (Resolve-Path (Join-Path (Join-Path $PSScriptRoot "..") "..")) $repoPath
    }

    if (-not (Test-Path $repoPath)) {
        $results += [pscustomobject]@{
            repo = $repo.name
            exists = $false
            status = "missing-repo"
            exit_code = -1
            critical_or_high = "unknown"
            details = "repo not found"
        }
        continue
    }

    Push-Location $repoPath
    try {
        $command = Resolve-SecurityCommand -RepoPath $repoPath
        if (-not $command) {
            $results += [pscustomobject]@{
                repo = $repo.name
                exists = $true
                status = "missing-audit-command"
                exit_code = -1
                critical_or_high = "unknown"
                details = "No known dependency audit command for repository"
            }
            continue
        }

        $previousErrorAction = $ErrorActionPreference
        $ErrorActionPreference = "Continue"
        $output = & cmd /c $command 2>&1
        $exitCode = $LASTEXITCODE
        $ErrorActionPreference = $previousErrorAction

        $joined = ($output -join "`n")
        $joined = [regex]::Replace($joined, "\x1B\[[0-9;]*[A-Za-z]", "")

        $hasCritical = $joined -match "critical"
        $hasHigh = $joined -match "high"
        $hasAuditabilityIssue = $joined -match "Dependency not found on PyPI|Failed to build|Failed to install packages"
        $criticalOrHigh = if ($hasCritical -or $hasHigh) { "detected" } else { "not-detected" }
        $status = if ($criticalOrHigh -eq "detected") {
            "gap"
        } elseif ($exitCode -eq 0) {
            "ok"
        } elseif ($hasAuditabilityIssue) {
            "warn-non-auditable"
        } else {
            "gap"
        }

        $results += [pscustomobject]@{
            repo = $repo.name
            exists = $true
            status = $status
            exit_code = $exitCode
            critical_or_high = $criticalOrHigh
            details = if ([string]::IsNullOrWhiteSpace($joined)) { "-" } else { ($joined -split "`n" | Select-Object -Last 5) -join " | " }
        }
    }
    finally {
        Pop-Location
    }
}

if (-not (Test-Path "output")) {
    New-Item -ItemType Directory -Path "output" | Out-Null
}

$summary = [pscustomobject]@{
    generated_at = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssK")
    target = "zero known critical/high vulnerabilities"
    repos = $results
}

$summary | ConvertTo-Json -Depth 8 | Set-Content -Path $OutputJsonPath

$lines = @()
$lines += "# Dependency Vulnerability Rollup"
$lines += ""
$lines += "- Generated: $($summary.generated_at)"
$lines += "- Target: $($summary.target)"
$lines += ""
$lines += "| Repo | Status | Exit Code | Critical/High | Details |"
$lines += "|---|---|---:|---|---|"
foreach ($row in $results) {
    $details = ($row.details -replace "\|", "\\|")
    $lines += "| $($row.repo) | $($row.status) | $($row.exit_code) | $($row.critical_or_high) | $details |"
}

Set-Content -Path $OutputMarkdownPath -Value ($lines -join "`n")
Write-Host "Wrote $OutputJsonPath"
Write-Host "Wrote $OutputMarkdownPath"
