param(
    [string]$ReposPath = "automation/repos.json",
    [string]$OutputJsonPath = "output/dependency-vulnerability-rollup.json",
    [string]$OutputMarkdownPath = "output/dependency-vulnerability-rollup.md"
)

$ErrorActionPreference = "Stop"
$PSNativeCommandUseErrorActionPreference = $false

$backendRepos = @(
    "lotus-gateway",
    "lotus-advise",
    "lotus-performance",
    "lotus-core",
    "lotus-report"
)

$securityCommands = @{
    "lotus-gateway" = "python -m pip_audit -r requirements-audit.txt"
    "lotus-advise" = "python scripts/dependency_health_check.py --requirements requirements.txt"
    "lotus-performance" = "python scripts/dependency_health_check.py --requirements requirements.txt"
    "lotus-core" = "python -m pip_audit -r tests/requirements.txt"
    "lotus-report" = "python -m pip_audit -r requirements-audit.txt"
}

if (-not (Test-Path $ReposPath)) {
    throw "Repos config not found: $ReposPath"
}

$repos = Get-Content -Raw $ReposPath | ConvertFrom-Json
$results = @()

foreach ($repo in $repos) {
    if ($backendRepos -notcontains $repo.name) { continue }

    $repoPath = $repo.path
    if (-not (Test-Path $repoPath)) {
        $results += [pscustomobject]@{
            repo = $repo.name
            exists = $false
            status = "missing-repo"
            exit_code = -1
            critical_or_high = "unknown"
            details = "repo not found"
        }
        continue
    }

    Push-Location $repoPath
    try {
        $command = $securityCommands[$repo.name]
        if (-not $command) {
            throw "No security command configured for repo: $($repo.name)"
        }
        $previousErrorAction = $ErrorActionPreference
        $ErrorActionPreference = "Continue"
        $output = & cmd /c $command 2>&1
        $exitCode = $LASTEXITCODE
        $ErrorActionPreference = $previousErrorAction
        $joined = ($output -join "`n")
        $joined = [regex]::Replace($joined, "\x1B\[[0-9;]*[A-Za-z]", "")

        $hasCritical = $joined -match "critical"
        $hasHigh = $joined -match "high"
        $hasAuditabilityIssue = $joined -match "Dependency not found on PyPI|Failed to build|Failed to install packages"
        $criticalOrHigh = if ($hasCritical -or $hasHigh) { "detected" } else { "not-detected" }
        $status = if ($criticalOrHigh -eq "detected") {
            "gap"
        } elseif ($exitCode -eq 0) {
            "ok"
        } elseif ($hasAuditabilityIssue) {
            "warn-non-auditable"
        } else {
            "gap"
        }

        $results += [pscustomobject]@{
            repo = $repo.name
            exists = $true
            status = $status
            exit_code = $exitCode
            critical_or_high = $criticalOrHigh
            details = if ([string]::IsNullOrWhiteSpace($joined)) { "-" } else { ($joined -split "`n" | Select-Object -Last 5) -join " | " }
        }
    }
    finally {
        Pop-Location
    }
}

if (-not (Test-Path "output")) {
    New-Item -ItemType Directory -Path "output" | Out-Null
}

$summary = [pscustomobject]@{
    generated_at = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssK")
    target = "zero known critical/high vulnerabilities"
    repos = $results
}

$summary | ConvertTo-Json -Depth 8 | Set-Content -Path $OutputJsonPath

$lines = @()
$lines += "# Dependency Vulnerability Rollup"
$lines += ""
$lines += "- Generated: $($summary.generated_at)"
$lines += "- Target: $($summary.target)"
$lines += ""
$lines += "| Repo | Status | Exit Code | Critical/High | Details |"
$lines += "|---|---|---:|---|---|"
foreach ($row in $results) {
    $details = ($row.details -replace "\|", "\\|")
    $lines += "| $($row.repo) | $($row.status) | $($row.exit_code) | $($row.critical_or_high) | $details |"
}

Set-Content -Path $OutputMarkdownPath -Value ($lines -join "`n")
Write-Host "Wrote $OutputJsonPath"
Write-Host "Wrote $OutputMarkdownPath"


